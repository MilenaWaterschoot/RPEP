<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/> <!-- import the jsPsych core library, specific plugins, jquery and some custom scripts-->
  <title>RPEP</title> <!-- defines a title in the browser tab -->
  <script src="jspsych-6.0.5/jspsych.js"></script> <!-- jsPsych core library -->
  <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script> <!-- plugins define the specific tasks -->
  <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-categorize-html.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-survey-text-beta-6.1.js"></script> <!-- beta 6.1 version has the 'input required' function for text fields -->
  <script src="jspsych-6.0.5/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-instructions.js"></script>
  <script src="UPPSP.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-survey-likert.js"></script>
  <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
  <script src="js/jquery-1.7.1.min.js"></script> <!-- the jquery library is used to communicate with the server (to store the data) through "AJAX" and PHP -->
  <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link> <!-- jsPsych css stylesheet -->
</head>
<body></body>
<script>

/* initialization */

// create timeline 
var timeline = [];

// create an empty variable to keep track of which trial it is
var trial_ind = 1;

// defining all the images so they can be preloaded
var all_images = ['img/yellow.png', 'img/orange.png', 'img/green.png','img/blue.png'
];

// is the experiment running from a server or not? (this determines if data is saved on server or offline)
if (document.location.host) { // returns your host or null
  online = true;
} else {
  online = false;
};

// all the messages below will be pushed into the timeline at the end of the script
// welcome message
var welcome = {
    type: 'html-keyboard-response',
    stimulus: `
    <p>Welcome to the experiment.</p>
    <p>Please make sure you are in a calm environment.</p>
    >p>Turn off music, cell phone and other devices that might be distracting.</p>
    <p>Press an arrow key to begin.</p>
    `,
    choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

/*********** fullscreen mode ***********/
var fullscreen_mode = {
type: 'fullscreen',
fullscreen_mode: true
};

// informed consent trial.
var consent = {
type: 'instructions',
pages: ['<p>We need your consent to proceed.</p> '+
    '<p> This is a research project conducted at Ghent University.</p>'+
    '<p> In this experiment, you will play a gambling game.</p>'+
    '<p> The data we collect during the experiment are not linked to any potentially identifying information. These data will solely be used for research purposes.</p>'+
    '<p> Anonymized data from the study will be registered and archived at a trusted public data repository in order to make them available to other researchers in line with current data sharing practices. </p>'+ // is this also the case for me?
    '<p> You are free to stop the experiment by closing your browser window at any time.</p>'+
    '<p> Non-participation or withdrawal from the study will not be of any disadvantage to you.</p>'+
    '<p> If you have any questions, you can contact Milena Waterschoot at milena.waterschoot@ugent.be or the lead researcher Charlotte Eben at charlotte.eben@ugent.be. </p>'+
    '<p> By clicking “I agree”, you affirm that you are at least 18 years of age, which is the minimum age to participate in this study, and that you understand the nature of your participation in this research. If you do not wish to participate, please close this window.</p>'],
show_clickable_nav: true,
button_label_next: "I agree",
allow_backward: false
};

// get participant's gender and add it to the datafile
var gender = {
type: 'survey-multi-choice',
questions: [{
    prompt: "Please enter your gender",
    required: true,
    options: ["Male", "Female", "Non-binary", "Prefer not to say"]
}, ],
on_finish: function(data) {
    data.trial_type = 'survey-multi-choice';
    var responses = JSON.parse(data.responses);
    var code = responses.Q0;
    jsPsych.data.addProperties({
    gender: code
    });
}
};

/* defining the cards */
yellow = "<img src='img/yellow.png'></img>";
orange = "<img src='img/orange.png'></img>";
green = "<img src='img/green.png'></img>";
blue = "<img src='img/blue.png'></img>";

/* initializing the text messages */
// the instructions
var instructions = {
  type: 'html-keyboard-response',
  stimulus: `
    <br>The game you are going to play, goes as follows:</br>
    <br>You must earn as many points as you can by choosing one of the two cards that will appear on the screen.</br>
    <br>If you pick the correct card, you will earn 5 points. However, if you pick the wrong card, you will loose 5 points.</br>
    <br>This is a chance game. You have a 50% chance of picking the correct card and a 50% chance of picking the wrong card.</br>
    <br>You can't know which card is the right one so you must take a gamble.</br>
    <br>Your starting amount will be 200 points.</br>
    <br>When you want the card on the left, press "<".</br>
    <br>When you want the card on the right, press ">".</br>
    <br>Press any arrow key to continue.</br>
  `,
  choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

// practice block message
var practice_message = {
  type: 'html-keyboard-response',
  stimulus: `
  <br>We will start with three practice games.</br>
  <br>The points you win or lose in the following three games won't be added or subtracted from your starting amount.</br>
        
  <p>Press an arrow key to continue.</p>
  `,
  choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

// message that anounces that the real experiment will start
var real_experiment_message = {
  type: 'html-keyboard-response',
  stimulus: `
  <br>The practice block is over.</br>
        
  <p>Press an arrow key to start the real game.</p>
  `,
  choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

// message that says they can take a break 
// is shown between blocks
var block_end = {
  type: 'html-keyboard-response',
  stimulus: `
  <p>If you want, you can take a break.</p>
  <p>Press an arrow key when you are ready to continue.</p>
  `,
  choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};


/* creating the different sequences */
// each of these sequences will be pushed into the timeline at the end of the script
// first, we make a seperate trial because we want to say "Press an arrow key to start" and not "... to start the next gamble"
var first_trial = {
    timeline: [
        {
            type: 'html-keyboard-response',
            stimulus: "Press an arrow key to start",
            choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
            on_finish: function(data) {
                // this labels the trial in the debug console, is handy for the progammer
                console.log('start', data); 
                /*** How fast did the participant initialize the next gamble? ***/
                // get the data 
                var startRT = jsPsych.data.get().select('rt');
                console.log("startRT", startRT) // this shows the registred startRT -> compare this to what the csv file saves
            }
                    },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('cards'),
            choices: ['leftarrow', 'rightarrow'],
            on_finish: function(data) {
                data.trial_type = 'task';
                // this labels the trial in the debug console, is handy for the progammer
                console.log('cards', data)
                /*** How fast did the participant chose a card? ***/
                // get the data 
                var choiceRT = jsPsych.data.get().select('rt');
                console.log("choiceRT", choiceRT) // this shows the registred choiceRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('feedback'),         
            choices: "NO_KEYS",
            trial_duration: 1000,
            on_finish: function(data) {
                // to tag the trial with the label 'feedback'
                console.log('feedback', data);
                // this shows whether the participant lost or won
                data.outcome = jsPsych.timelineVariable('feedback', true);  
            }
        }
    ],
    timeline_variables: [                       
        { cards: yellow, feedback: '+5' }
    ]
    };


// now we can make the different sequences
var practice_sequence = {
    timeline: [
        {
            type: 'html-keyboard-response',
            stimulus: "Press an arrow key to start the next gamble",
            choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
            on_finish: function(data) {
                // this labels the trial in the debug console, is handy for the progammer
                console.log('start', data); 
                /*** How fast did the participant initialize the next gamble? ***/
                // get the data 
                var startRT = jsPsych.data.get().select('rt');
                console.log("startRT", startRT) // this shows the registred startRT -> compare this to what the csv file saves
            }
                    },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('cards'),
            choices: ['leftarrow', 'rightarrow'],
            on_finish: function(data) {
                data.trial_type = 'task';
                // this labels the trial in the debug console, is handy for the progammer
                console.log('cards', data)
                /*** How fast did the participant chose a card? ***/
                // get the data 
                var choiceRT = jsPsych.data.get().select('rt');
                console.log("choiceRT", choiceRT) // this shows the registred choiceRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('feedback'),         
            choices: "NO_KEYS",
            trial_duration: 1000,
            on_finish: function(data) {
                // to tag the trial with the label 'feedback'
                console.log('feedback', data);
                // this shows whether the participant lost or won
                data.outcome = jsPsych.timelineVariable('feedback', true);  
            }
        }
    ],
    timeline_variables: [                       // this consist of thee trials, these are shown via the timeline in the order in which they are written
        { cards: green, feedback: '-5' },
        { cards: blue, feedback: '+5' }
    ]
    };
var loss_sequence = {
    timeline: [
        {
            type: 'html-keyboard-response',
            stimulus: "Press an arrow key to start the next gamble",
            choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
            on_finish: function(data) {
                // this labels the trial in the debug console, is handy for the progammer
                console.log('start', data); 
                /*** How fast did the participant initialize the next gamble? ***/
                // get the data 
                var startRT = jsPsych.data.get().select('rt');
                console.log("startRT", startRT) // this shows the registred startRT -> compare this to what the csv file saves
            }
            },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('cards'),
            choices: ['leftarrow', 'rightarrow'],
            on_finish: function(data) {
                data.trial_type = 'task';
                // this labels the trial in the debug console, is handy for the progammer
                console.log('cards', data)
                /*** How fast did the participant chose a card? ***/
                // get the data 
                var choiceRT = jsPsych.data.get().select('rt');
                console.log("choiceRT", choiceRT) // this shows the registred choiceRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('feedback'),         
            choices: "NO_KEYS",
            trial_duration: 1000,
            on_finish: function(data) {
                // to tag the trial with the label 'feedback'
                console.log('feedback', data);
                // this shows whether the participant lost or won
                data.outcome = jsPsych.timelineVariable('feedback', true);  
            }
        }
    ],
    timeline_variables: [
        { cards: blue, feedback: '+5' },
        { cards: green, feedback: '-5' },
        { cards: yellow, feedback: '-5' },
        { cards: blue, feedback: '-5' },
        { cards: green, feedback: '-5' },
        { cards: yellow, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: blue, feedback: '-5' },
        { cards: yellow, feedback: '-5' },
        { cards: blue, feedback: '+5' },
        { cards: orange, feedback: '+5' },
        { cards: green, feedback: '-5' },
        { cards: yellow, feedback: '-5' },
        { cards: green, feedback: '+5' },
        { cards: blue, feedback: '-5' }
    ]
    };

var random_sequence_1 = {
    timeline: [
    {
            type: 'html-keyboard-response',
            stimulus: "Press an arrow key to start the next gamble",
            choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
            on_finish: function(data) {
                // this labels the trial in the debug console, is handy for the progammer
                console.log('start', data); 
                /*** How fast did the participant initialize the next gamble? ***/
                // get the data 
                var startRT = jsPsych.data.get().select('rt');
                console.log("startRT", startRT) // this shows the registred startRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('cards'),
            choices: ['leftarrow', 'rightarrow'],
            on_finish: function(data) {
                data.trial_type = 'task';
                // this labels the trial in the debug console, is handy for the progammer
                console.log('cards', data)
                /*** How fast did the participant chose a card? ***/
                // get the data 
                var choiceRT = jsPsych.data.get().select('rt');
                console.log("choiceRT", choiceRT) // this shows the registred choiceRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('feedback'),         
            choices: "NO_KEYS",
            trial_duration: 1000,
            on_finish: function(data) {
                // to tag the trial with the label 'feedback'
                console.log('feedback', data);
                // this shows whether the participant lost or won
                data.outcome = jsPsych.timelineVariable('feedback', true);  
            }
        }
    ],
    timeline_variables: [
        { cards: blue, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: blue, feedback: '+5' },
        { cards: green, feedback: '-5' },
        { cards: orange, feedback: '-5' },
        { cards: blue, feedback: '+5' },
        { cards: yellow, feedback: '-5' },
        { cards: green, feedback: '+5' },
        { cards: yellow, feedback: '-5' },
        { cards: green, feedback: '+5' },
        { cards: green, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: yellow, feedback: '-5' },
        { cards: blue, feedback: '+5' },
        { cards: yellow, feedback: '-5' }
    ]
    };

var random_sequence_2 = {
    timeline: [
        {
            type: 'html-keyboard-response',
            stimulus: "Press an arrow key to start the next gamble",
            choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
            on_finish: function(data) {
                // this labels the trial in the debug console, is handy for the progammer
                console.log('start', data); 
                /*** How fast did the participant initialize the next gamble? ***/
                // get the data 
                var startRT = jsPsych.data.get().select('rt');
                console.log("startRT", startRT) // this shows the registred startRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('cards'),
            choices: ['leftarrow', 'rightarrow'],
            on_finish: function(data) {
                data.trial_type = 'task';
                // this labels the trial in the debug console, is handy for the progammer
                console.log('cards', data)
                /*** How fast did the participant chose a card? ***/
                // get the data 
                var choiceRT = jsPsych.data.get().select('rt');
                console.log("choiceRT", choiceRT) // this shows the registred choiceRT -> compare this to what the csv file saves
            }
        },
        {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('feedback'),         
            choices: "NO_KEYS",
            trial_duration: 1000,
            on_finish: function(data) {
                // to tag the trial with the label 'feedback'
                console.log('feedback', data);
                // this shows whether the participant lost or won
                data.outcome = jsPsych.timelineVariable('feedback', true);  
            }
        }
    ],
    timeline_variables: [
        { cards: green, feedback: '-5' },
        { cards: yellow, feedback: '+5' },
        { cards: orange, feedback: '-5' },
        { cards: orange, feedback: '+5' },
        { cards: orange, feedback: '+5' },
        { cards: yellow, feedback: '-5' },
        { cards: green, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: orange, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: yellow, feedback: '-5' },
        { cards: orange, feedback: '+5' },
        { cards: yellow, feedback: '+5' },
        { cards: blue, feedback: '-5' },
        { cards: orange, feedback: '+5' }
    ]
    };

// overall feedback message
var overall_feedback = {
    type: 'html-keyboard-response',
    stimulus: `
    <p>You have finished the gambling game.</p>
    <P>You ended up with a total of 100 points.</p>
    <p>Press an arrow key to continue.</p>
    `,
    choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

// the message that is shown after the task is done 
var instruction_for_the_question = {
    type: 'html-keyboard-response',
    stimulus: `
    <P>Please answer the question on the next page and then you are finished.</p>
    <p>Press an arrow key to see the question.</p>
    `,
    choices: ['leftarrow', 'rightarrow', 'downarrow', 'uparrow'],
};

/*********** manipulation check ***********/
// a yes/no statment to see whether the participant is prone to believing in the gambler's fallacy? 
var manipulation_check = {
  type: 'survey-multi-choice',
  questions: [{
    prompt: "When I’m gambling, I should keep the same bet even when it hasn’t come up lately because it is bound to win.",
    options: ["yes", "no"],
    required: true
  }, ],
  on_start: function() {
    document.body.style.cursor = 'auto'; // show the mouse cursor
  },
  on_finish: function(data) {
    data.trial_type = 'survey-multi-choice';
    var responses = JSON.parse(data.responses);
    var code = responses.Q0;
    jsPsych.data.addProperties({
      manipulation: code
    });
  }
};

/*** the debriefing message ***/
var debrief_message = {
    type: 'html-keyboard-response',
    stimulus: `
    <p>Thank you for participating!</p>
    <p>In this study, we are interested in impulsive actions. When gambling, people tend to start their next game faster after losing than after winning. This is believed to be an impulsive action.
    <p>In this research we wanted to test whether losing frequently has an influence on this action. This is why you lost more than you won. The frequency of losing and the order in which this happend was predetermined by us.</p>
    <p>We really appreciate your participation and contribution to this research. If you have any questions, you can contact the researcher at milena.waterschoot@ugent.be.</p>
    `
};

/* creating the timeline */
// the welcome message
timeline.push(welcome);
// set to fullscreen mode
timeline.push(fullscreen_mode);
// show informed consent
timeline.push(consent); 
// ask gender
timeline.push(gender);
// the instructions
timeline.push(instructions);
// practice block
timeline.push(practice_message);
timeline.push(first_trial);
timeline.push(practice_sequence); 
// anouncement that we will start the real game
timeline.push(real_experiment_message);
// block 1
timeline.push(loss_sequence);
timeline.push(random_sequence_1);
timeline.push(block_end); 
// block 2
timeline.push(loss_sequence);
timeline.push(random_sequence_2);
timeline.push(block_end);
// block 3
timeline.push(loss_sequence);
timeline.push(random_sequence_1);
timeline.push(block_end); 
// block 4
timeline.push(loss_sequence);
timeline.push(random_sequence_2);
timeline.push(block_end); 
// tell the participant with how many points they ended up
timeline.push(overall_feedback);
// announcement that they are done with the gambling task and have to fill in one last question 
timeline.push(instruction_for_the_question);
// show the manipulation check
timeline.push(manipulation_check);
// debrief message
timeline.push(debrief_message);

/*** function that appends data to an existing file (or creates the file if it does not exist) ***/
function appendData(filename, filedata) {
  $.ajax({ // make sure jquery-1.7.1.min.js is loaded in the html header for this to work
    type: 'post',
    cache: false,
    url: 'php/save_data_append.php',
    data: {
      filename: filename,
      filedata: filedata
    },
  });
};


/*** start the experiment and save data ***/
jsPsych.init({
  timeline: timeline,
  preload_images: all_images,
  on_data_update: function(data){
     if (online){ // you can only write data when you run the experiment online
        if (data.trial_index == 1){ // write header at first event
          data_row = "gender, outcome, startRT, choiceRT, manipulation\n"
          appendData('RPRP_data'+'.csv', data_row) 
        } else if (data.trial_type == 'task' || data.trial_type == 'survey-multi-choice'){ // append data for these certain trial types
          data_row = data.gender + ',' + data.outcome + ',' + data.startRT + ',' + data.choiceRT + ',' + data.manipulation +  '\n'
          appendData('RPEP_data'+ '.csv', data_row)
        }
      }
    },

})
</script>

</html>